<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Umesh Wisvantha</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      background-color: #f9f9f9;
      margin: 0;
      padding: 0 10px 40px;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      justify-content: space-between;
    }
    h1 {
      margin-top: 30px;
      font-size: 1.8rem;
    }
    .relay-card {
      display: inline-block;
      background-color: white;
      padding: 20px;
      margin: 15px;
      border-radius: 15px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      width: 220px;
      vertical-align: top;
    }
    .relay-card h2 {
      margin-bottom: 10px;
      font-size: 1.3rem;
    }
    .relay-card button {
      padding: 10px 20px;
      border: none;
      border-radius: 10px;
      color: white;
      background-color: blue;
      cursor: pointer;
      font-size: 16px;
      width: 90%;
      transition: opacity 0.3s ease;
    }
    #allOffBtn, #logoutBtn, #voiceBtn {
      max-width: 300px;
      width: 90%;
      padding: 12px 25px;
      font-size: 16px;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      margin: 15px auto;
      display: block;
      color: white;
      transition: opacity 0.3s ease;
    }
    #allOffBtn { background-color: #d32f2f; }
    #logoutBtn { background-color: #555; }
    #voiceBtn { background-color: #009688; }
    #dashboard { display: none; }
    #loginForm {
      max-width: 400px;
      margin: 80px auto 20px;
      background: white;
      padding: 30px 20px;
      border-radius: 15px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
  </style>
</head>
<body>

<h1>MyHome Dashboard</h1>

<!-- Login -->
<div id="loginForm">
  <input type="email" id="email" placeholder="Enter Email" required />
  <input type="password" id="password" placeholder="Enter Password" required />
  <button id="loginBtn">Login</button>
</div>

<!-- Dashboard -->
<div id="dashboard">

  <!-- ðŸ”µ NEW VOICE BUTTON -->
  <button id="voiceBtn">ðŸŽ¤ Voice Assistant</button>
  <p id="voiceStatus" style="font-size:14px; color:#444; margin-top:-10px;"></p>

  <div class="relay-container">

    <div class="relay-card">
      <h2>Switch 1</h2>
      <p>Status: <span id="status1">Loading...</span></p>
      <button id="btn1">Toggle</button>
    </div>

    <div class="relay-card">
      <h2>Switch 2</h2>
      <p>Status: <span id="status2">Loading...</span></p>
      <button id="btn2">Toggle</button>
    </div>

    <div class="relay-card">
      <h2>Switch 3</h2>
      <p>Status: <span id="status3">Loading...</span></p>
      <button id="btn3">Toggle</button>
    </div>

    <div class="relay-card">
      <h2>Switch 4</h2>
      <p>Brightness: <span id="dimmerValue">0%</span></p>
      <input type="range" id="dimmerSlider" min="0" max="100" step="25" style="width:90%; margin-top:20px;" />
    </div>

  </div>

  <button id="allOffBtn">All OFF</button>
  <button id="logoutBtn">Logout</button>
</div>

<footer>Created by L.U.W. Liyanage</footer>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>

<script>
/* ------------------------------
   Your existing Firebase + login code
   (UNCHANGED)
-------------------------------- */
const firebaseConfig = {
  apiKey: "AIzaSyCUzdKCLdsudEWhuGdLjg0CXF2cl8xJAWM",
  authDomain: "myesphome-851f9.firebaseapp.com",
  databaseURL: "https://myesphome-851f9-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "myesphome-851f9",
  storageBucket: "myesphome-851f9.appspot.com",
  messagingSenderId: "658789168181",
  appId: "1:658789168181:web:0794c1585891c117a3ad7c"
};

firebase.initializeApp(firebaseConfig);
const allowedEmail = "umeshviswantha@gmail.com";
const allowedPassword = "@1Liyanage09";
const loginForm = document.getElementById("loginForm");
const dashboard = document.getElementById("dashboard");

document.getElementById("loginBtn").onclick = () => {
  let email = document.getElementById("email").value.trim();
  let pass  = document.getElementById("password").value;
  if (email===allowedEmail && pass===allowedPassword){
    firebase.auth().signInWithEmailAndPassword(email, pass)
    .then(()=>{ loginForm.style.display="none"; dashboard.style.display="block"; startRelayControl(); })
    .catch(err=>alert(err.message));
  } else alert("Invalid Email or Password");
};

function startRelayControl(){
  const db = firebase.database();

  // RELAY 1â€“3
  [1,2,3].forEach(i=>{
    let ref = db.ref("/relay"+i);
    ref.on("value",snap=>{
      document.getElementById("status"+i).innerText = snap.val()?"ON":"OFF";
    });
    document.getElementById("btn"+i).onclick = ()=> ref.set(!document.getElementById("status"+i).innerText.includes("ON"));
  });

  // DIMMER
  const slider = document.getElementById("dimmerSlider");
  const dVal   = document.getElementById("dimmerValue");
  const dRef   = db.ref("/relay4");

  dRef.on("value", snap => {
    let v = snap.val(); if(v==null) return;
    slider.value = v; dVal.innerText = v+"%";
  });

  slider.oninput = ()=>{ dRef.set(parseInt(slider.value)); };

  document.getElementById("allOffBtn").onclick = ()=>{
    db.ref("/relay1").set(false);
    db.ref("/relay2").set(false);
    db.ref("/relay3").set(false);
    db.ref("/relay4").set(0);
  };
}

document.getElementById("logoutBtn").onclick = ()=>{
  firebase.auth().signOut().then(()=>{
    dashboard.style.display="none";
    loginForm.style.display="block";
  });
};
</script>

<!-- ========================================================= -->
<!-- ðŸ”µ NEW ADVANCED VOICE CONTROL ENGINE (Sinhala + English) -->
<!-- ========================================================= -->
<script>
const voiceBtn = document.getElementById("voiceBtn");
const voiceStatus = document.getElementById("voiceStatus");
const db = firebase.database();

let recognizing = false;
let wakeMode = true;
let wakeWord = "hey smart home";   // CUSTOM WAKE WORD
let lastCommand = "";

const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
const recognizer = new SpeechRecognition();
recognizer.lang = "en-US";  // Sinhala works here also (browser auto-detects)
recognizer.continuous = true;
recognizer.interimResults = false;

function speak(text){
  let msg = new SpeechSynthesisUtterance(text);
  msg.lang = "en-US";
  window.speechSynthesis.speak(msg);
}

function parseCommand(cmd){
  let text = cmd.toLowerCase();

  // --------------------
  // WAKE WORD
  // --------------------
  if (text.includes(wakeWord)){
    wakeMode = false;
    speak("Yes, I'm listening");
    return;
  }

  if (wakeMode) return;  // Ignore until wake word triggered

  // ------------------------------------------------------
  // SINHALA COMMANDS
  // ------------------------------------------------------
  if (text.includes("light eka on") || text.includes("switch ek on")){
    db.ref("/relay1").set(true);
    speak("Switch one turned on");
  }
  if (text.includes("light eka off")){
    db.ref("/relay1").set(false);
    speak("Switch one off");
  }

  if (text.includes("dimmer") && text.match(/\d+/)){
    let level = parseInt(text.match(/\d+/)[0]);
    if ([0,25,50,75,100].includes(level)){
      db.ref("/relay4").set(level);
      speak("Brightness set to " + level + " percent");
    } else speak("Invalid dimmer level");
  }

  // ------------------------------------------------------
  // ENGLISH NATURAL
  // ------------------------------------------------------
  if (text.includes("all lights on")){
    db.ref("/relay1").set(true);
    db.ref("/relay2").set(true);
    db.ref("/relay3").set(true);
    speak("All lights turned on");
  }
  if (text.includes("all lights off")){
    db.ref("/relay1").set(false);
    db.ref("/relay2").set(false);
    db.ref("/relay3").set(false);
    db.ref("/relay4").set(0);
    speak("Everything switched off");
  }

  if (text.includes("brighter")){
    db.ref("/relay4").get().then(s=>{
      let v = s.val(); v += 25; if(v>100) v=100;
      db.ref("/relay4").set(v);
      speak("Increasing brightness to "+v+" percent");
    });
  }

  if (text.includes("dimmer") || text.includes("reduce light")){
    db.ref("/relay4").get().then(s=>{
      let v = s.val(); v -= 25; if(v<0) v=0;
      db.ref("/relay4").set(v);
      speak("Brightness reduced to "+v+" percent");
    });
  }

  wakeMode = true;  // Reset wake mode
}

recognizer.onresult = (event)=>{
  let transcript = event.results[event.results.length-1][0].transcript.trim();
  voiceStatus.innerText = "Heard: " + transcript;
  parseCommand(transcript);
};

recognizer.onend = ()=>{ if(recognizing) recognizer.start(); };

voiceBtn.onclick = ()=>{
  if(!recognizing){
    recognizer.start();
    recognizing = true;
    voiceBtn.innerText = "ðŸŽ¤ Listening (Say: Hey Smart Home)";
    voiceStatus.innerText = "Waiting for wake word...";
  } else {
    recognizer.stop();
    recognizing = false;
    voiceBtn.innerText = "ðŸŽ¤ Voice Assistant";
    voiceStatus.innerText = "";
  }
};
</script>

</body>
</html>
