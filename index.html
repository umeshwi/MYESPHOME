<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>MyHome Dashboard â€” Voice Enabled</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    :root{
      --bg:#f4f7fb; --card:#ffffff; --accent:#0e8a74; --accent-2:#1565c0;
      --muted:#7a8a99; --danger:#d32f2f; --glass: rgba(255,255,255,0.6);
      --radius:14px; --shadow:0 8px 24px rgba(15,23,42,0.06);
    }
    body{
      margin:0;background:var(--bg);font-family:Arial,Helvetica,sans-serif;
      display:flex;justify-content:center;padding:20px;
    }
    .app{
      max-width:1080px;width:100%;border-radius:16px;padding:22px;
      background:linear-gradient(180deg,#ffffffd4,#fffffffa);
      box-shadow:var(--shadow);display:flex;gap:22px;
    }
    .left{width:340px}
    .right{flex:1}
    .card{
      background:var(--card);padding:16px;border-radius:12px;box-shadow:0 6px 16px rgba(0,0,0,0.06);
      margin-bottom:14px;
    }
    input{
      width:100%;padding:12px;border-radius:10px;border:1px solid #dde4ea;margin-bottom:12px;
      font-size:15px;
    }
    .btn{
      width:100%;padding:12px;font-size:16px;font-weight:600;border-radius:10px;border:none;
      color:#fff;background:var(--accent);cursor:pointer;transition:0.2s;
    }
    .btn:hover{opacity:0.85}
    .controls{display:flex;gap:12px;flex-wrap:wrap}
    .relay{
      width:220px;background:#fff;padding:15px;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,0.06)
    }
    .relay button{width:100%;padding:10px;border-radius:10px;border:none;color:#fff}
    .status{font-weight:600;color:#666;margin-bottom:8px}
    #voiceBtn{
      width:100%;padding:12px;font-size:17px;font-weight:600;border-radius:12px;border:none;
      background:#0e8a74;color:#fff;cursor:pointer;margin-bottom:10px;
    }
    #voiceBtn.listening{background:#d32f2f}
  </style>
</head>

<body>
<div class="app">
  <div class="left">

    <div class="card">
      <h2>Login</h2>
      <input id="email" type="email" placeholder="Email">
      <input id="password" type="password" placeholder="Password">
      <button id="loginBtn" class="btn">Login</button>
    </div>

    <div class="card">
      <h3>Voice Assistant</h3>
      <button id="voiceBtn">ðŸŽ¤ Start Voice Assistant</button>
      <p id="voiceStatus">Not listening</p>
      <p id="voiceTranscript" style="font-size:14px"></p>
      <p id="micHint" style="font-size:12px;color:#888"></p>
    </div>

  </div>

  <div class="right">
    <h2>Controls</h2>
    <div class="controls">

      <div class="relay">
        <h3>Switch 1</h3>
        <div class="status">Status: <span id="status1">â€”</span></div>
        <button id="btn1" style="background:#1565c0">Toggle</button>
      </div>

      <div class="relay">
        <h3>Switch 2</h3>
        <div class="status">Status: <span id="status2">â€”</span></div>
        <button id="btn2" style="background:#1565c0">Toggle</button>
      </div>

      <div class="relay">
        <h3>Switch 3</h3>
        <div class="status">Status: <span id="status3">â€”</span></div>
        <button id="btn3" style="background:#1565c0">Toggle</button>
      </div>

      <div class="relay">
        <h3>Dimmer</h3>
        <div class="status">Brightness: <span id="dimmerValue">0%</span></div>
        <input id="dimmerSlider" type="range" min="0" max="100" step="25" style="width:100%">
      </div>

    </div>

    <br>
    <button id="allOffBtn" class="btn" style="background:#d32f2f;width:200px">All OFF</button>
    <button id="logoutBtn" class="btn" style="background:#555;width:200px;margin-top:10px">Logout</button>
  </div>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>

<script>
/* ------------------------------
   Firebase Config
-------------------------------- */
const firebaseConfig = {
  apiKey: "AIzaSyCUzdKCLdsudEWhuGdLjg0CXF2cl8xJAWM",
  authDomain: "myesphome-851f9.firebaseapp.com",
  databaseURL: "https://myesphome-851f9-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "myesphome-851f9",
  storageBucket: "myesphome-851f9.appspot.com",
  messagingSenderId: "658789168181",
  appId: "1:658789168181:web:0794c1585891c117a3ad7c"
};
firebase.initializeApp(firebaseConfig);

/* ------------------------------
   Login System
-------------------------------- */
const allowedEmail = "umeshviswantha@gmail.com";
const allowedPassword = "@1Liyanage09";

let firebaseReady = false;     // FIX 1
let dbRoot = null;             // FIX 2

document.getElementById("loginBtn").onclick = async () => {
  let e = email.value.trim();
  let p = password.value;

  if (e === allowedEmail && p === allowedPassword) {
    await firebase.auth().signInWithEmailAndPassword(e, p);

    firebaseReady = true;                  // FIX 3
    dbRoot = firebase.database();          // FIX 4

    initControls();

    speak("Welcome. Voice assistant is now connected.");
  } else {
    alert("Wrong login!");
  }
};

/* ------------------------------
   Relay Controls
-------------------------------- */
function initControls() {
  const db = firebase.database();

  [1,2,3].forEach(i => {
    const ref = db.ref("/relay"+i);

    ref.on("value", snap => {
      document.getElementById("status"+i).innerText = snap.val() ? "ON" : "OFF";
    });

    document.getElementById("btn"+i).onclick = () => {
      ref.set( document.getElementById("status"+i).innerText === "OFF" );
    };
  });

  // Dimmer
  const dRef = db.ref("/relay4");
  dRef.on("value", snap => {
    let v = snap.val();
    dimmerSlider.value = v;
    dimmerValue.innerText = v + "%";
  });

  dimmerSlider.oninput = () => {
    dRef.set(parseInt(dimmerSlider.value));
  };

  allOffBtn.onclick = () => {
    db.ref("/relay1").set(false);
    db.ref("/relay2").set(false);
    db.ref("/relay3").set(false);
    db
